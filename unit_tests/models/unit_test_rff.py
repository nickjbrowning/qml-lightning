import torch
import numpy as np

import argparse
from qml_lightning.torchscript import setup # called to load torchscript libs from QML_LIGHTNING_TORCHSCRIPT_LIB

if __name__ == "__main__":
    
    actual_energy = -406746.26498811337
    
    coordinates = np.array([[ 2.25571364, -0.38562082,  0.25521779],
                         [ 0.83507879,  1.9715759 , -0.41464916],
                         [ 2.88876512,  0.84852166,  0.26907964],
                         [ 2.14876936,  2.01964345, -0.04776138],
                         [-3.48410053,  0.49229042, -0.10826158],
                         [ 0.92033708, -0.50883859, -0.10168934],
                         [ 0.21159328,  0.68818845, -0.42443103],
                         [-0.96446081, -1.83211358, -0.39899052],
                         [-1.65259035,  0.8639225 ,  1.35082265],
                         [ 0.88341369, -2.88346755,  0.19632983],
                         [ 0.22071292, -1.79338057, -0.09240105],
                         [-2.05297017,  0.69330798,  0.24948384],
                         [-1.12429142,  0.6204384 , -0.81430244],
                         [ 0.29509341, -3.64658463,  0.43020677],
                         [ 2.66286461, -1.38969562,  0.4938589 ],
                         [ 0.26339145,  2.78767702, -0.91261049],
                         [ 3.94534538,  0.95482407,  0.58319346],
                         [ 2.74120081,  2.93792725, -0.25633347],
                         [-3.86742258, -0.54453643, -0.04496527],
                         [-4.02107013,  1.29272799,  0.46787286],
                         [-3.64746502,  0.93253809, -1.11074989]])
    
    actual_forces = np.array(
                        [[  7.89330996, -23.78912768,   4.75720496],
                         [-38.27593486, -31.65179859, -23.22267552],
                         [  5.21347896,  10.2603322 ,  13.09139135],
                         [ 50.5363484 ,   6.61211691, -15.55595476],
                         [-12.72959065,  46.13122006, -25.23051101],
                         [ -9.58919845,  34.00624946,  -2.14151264],
                         [ -4.02681556,   3.9549125 ,   2.12373134],
                         [-12.01427352, -16.60541945,   6.77979629],
                         [ 11.33458458,  11.20022527,  55.77121139],
                         [ 47.83550316, -43.44880385,  27.73867976],
                         [-59.10512603,  24.5090502 , -24.75256802],
                         [ 12.76864844, -23.085553  , -30.7630836 ],
                         [-12.56774628,  14.78405338,  -7.55859095],
                         [  0.42237233,  18.79314136, -12.5848658 ],
                         [ 15.32161419,  20.22681044,   1.20607638],
                         [ 10.33235702,  -6.90958355,  17.34088206],
                         [-11.3081238 ,  -3.24890291,  -6.62375556],
                         [-10.26088399,  -7.22121239,  13.23349569],
                         [  5.65715804,  12.01787416,   4.4747182 ],
                         [  0.27872805, -28.06318756,   8.05143185],
                         [  2.28359002, -18.47239697,  -6.13510139],])

    
    charges = np.array([6, 6, 6, 6, 6, 6, 6, 8, 8, 8, 6, 6, 8, 1, 1, 1, 1, 1, 1, 1, 1])
    
    ref_energy = -406746.5000
    ref_forces = np.array([[  6.5116, -24.0388,   5.3613],
                         [-41.0136, -31.1613, -23.5924],
                         [  3.7873,  10.4274,  11.3634],
                         [ 51.3268,   6.9933, -14.5404],
                         [-13.3176,  45.0558, -25.3040],
                         [ -6.9158,  34.2748,  -2.7024],
                         [ -0.9840,   3.6060,  -2.4016],
                         [-11.2576, -13.8162,   5.2176],
                         [ 11.5152,  12.3906,  54.7288],
                         [ 48.6763, -43.8363,  27.6297],
                         [-59.5483,  21.0851, -22.5117],
                         [ 11.0606, -24.8027, -28.5321],
                         [ -9.4783,  16.6269,  -5.1595],
                         [  0.0906,  18.6853, -12.1778],
                         [ 13.6301,  19.4588,   1.5360],
                         [  9.6355,  -7.0155,  17.3037],
                         [-11.5911,  -3.7565,  -6.6944],
                         [-10.2631,  -6.5833,  13.7146],
                         [  5.5751,  12.1859,   4.4857],
                         [ -0.7187, -27.7020,   8.2125],
                         [  3.2792, -18.0770,  -5.9367]])
    
    X = torch.from_numpy(coordinates).float().cuda()
    Z = torch.from_numpy(charges).float().cuda()
    
    X.requires_grad = True
    X = X.unsqueeze(0)
    Z = Z.unsqueeze(0)
    
    molIDs = torch.zeros(coordinates.shape[0], dtype=torch.int).cuda()
    atomIDs = torch.arange(coordinates.shape[0], dtype=torch.int).cuda()
    atom_counts = torch.zeros(1).fill_(coordinates.shape[0]).int().cuda()
    
    loaded = torch.jit.load('model_rff.pt')
    
    energy_prediction = loaded.forward(X, Z, atomIDs, molIDs, atom_counts)
    
    forces_prediction, = torch.autograd.grad(-energy_prediction.sum(), X)

    
    assert np.isclose(ref_energy,  loaded.self_energy[Z.long()].sum() + energy_prediction.cpu().item()), "predicted energy is not close to ref_energy"
    assert np.isclose(ref_forces,  forces_prediction.cpu().squeeze(0).numpy(), rtol=1e-4, atol=1e-4).all(), "predicted forces is not close to ref_forces"
    
    print ("All is well!")
